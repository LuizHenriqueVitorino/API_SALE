name: Teste AutomÃ¡tico

on:
  push:
    branches:
      - main

jobs:
  Roda_A_API:
    runs-on: self-hosted

    steps:
    - name: Check out code
      uses: actions/checkout@v3

    - name: Install Flask
      run: pip install Flask
    
    - name: Install Robot and libraries
      run: |
        pip install robotframework
        pip install robotframework-requests

    - name: Start API
      run: |
        python3 mockes/mocke_sale.py &
        echo $! > api_pid.txt # Salva o PID da API em um arquivo
        sleep 2

    - name: Run Tests
      run: |
        robot testes/login_test.robot

    - name: Stop API
      run: |
        API_PID=$(cat api_pid.txt) # LÃª o PID da API do arquivo
        kill $API_PID # Interrompe a execuÃ§Ã£o da API

  notifyTelegram:
    name: Notify deploy status ğŸš€
    needs: [Roda_A_API]
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
    # - name: Install docker
    #     run: |
    #       apt-get update && apt-get install --no-install-recommends -y ca-certificates curl gnupg lsb-release sudo
    #       curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    #       echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    #       apt-get update && apt-get install --no-install-recommends -y docker-ce docker-ce-cli containerd.io
    - name: send custom message
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        format: markdown
        message: |
          âœ… Nova versÃ£o de *${{ env.STAGE_NAME }}* disponÃ­vel!
            â¿ ğŸ“Œ Autor responsÃ¡vel: ${{ github.actor }}

            âœï¸ De: [${{ github.repository }}](${{ github.repository.html_url }})

            ğŸ·ï¸ VersÃ£o : ```${{ env.PR_NUMBER_OR_MASTER }}```
            â¿ ğŸ› ï¸ Build : #```${{ github.run_number }}```

            ğŸ§¬ AlteraÃ§Ãµes: [Aqui!](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            ğŸ“¦ Deploy: [Aqui!](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            Esta Ã© uma mensagem automÃ¡tica e informativa. Por favor, nÃ£o responda.

  notifyTelegramTEste1:
    name: Notify deploy status Teste1 ğŸš€
    needs: [Roda_A_API]
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
    - name: Teste 1
      uses: appleboy/telegram-action@master
      with:
        to: 5036257879
        token: ${{ secrets.TELEGRAM_TOKEN }}
        format: markdown
        message: |
          âœ… Teste 1

  notifyTelegramTEste2:
    name: Notify deploy status Teste2 ğŸš€
    needs: [Roda_A_API]
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
    - name: Teste 2
      uses: appleboy/telegram-action@master
      with:
        to: -4088268458
        token: ${{ secrets.TELEGRAM_TOKEN }}
        format: markdown
        message: |
          âœ… Deus Ã© mais!

  notifyTelegramTEste3:
    name: Notify deploy status Teste3 ğŸš€
    needs: [Roda_A_API]
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
    - name: Teste 3
      uses: appleboy/telegram-action@master
      with:
        to: 4088268458
        token: ${{ secrets.TELEGRAM_TOKEN }}
        format: markdown
        message: |
          âœ… Teste 3
          
  NotificaAiPraMim:
    name: Notifica aÃ­ pra mim! ğŸš€
    needs: [Roda_A_API]
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
    - name: Teste 3
      uses: appleboy/telegram-action@master
      with:
        to: 6082736518
        token: ${{ secrets.TELEGRAM_TOKEN }}
        format: markdown
        message: |
          âœ… Notificou!!!!!!


    # - name: Send error build message to Telegram ğŸ’¬âŒ
    #     if: ${{ always() && (needs.deploy.result == 'failure') }}
    #     uses: appleboy/telegram-action@master
    #     env:
    #       GITHUB_CONTEXT: ${{ toJSON(github) }}
    #       PR_NUMBER_OR_MASTER: ${{ github.event.number == 0 && 'stable from master' ||  format('#{0}', github.event.number)  }}
    #       STAGE_NAME: ${{ github.ref == 'refs/heads/master' && 'produÃ§Ã£o' || 'desenvolvimento' }}

    #     with:
    #       to: ${{ secrets.TELEGRAM_ID }}
    #       token: ${{ secrets.TELEGRAM_TOKEN }}
    #       format: markdown
    #       message: |
    #         âŒ Nova versÃ£o de *${{ env.STAGE_NAME }}* nÃ£o disponÃ­vel, pois falhou!
    #         â¿ ğŸ“Œ Autor responsÃ¡vel: ${{ github.actor }}

    #         âœï¸ De: [${{ github.repository }}](https://github.com/${{ github.repository }})

    #         ğŸ·ï¸ VersÃ£o : ```${{ env.PR_NUMBER_OR_MASTER }}```
    #         â¿ ğŸ› ï¸ Build : #```${{ github.run_number }}```

    #         ğŸ§¬ AlteraÃ§Ãµes: [Aqui!](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
    #         ğŸ“¦ Deploy: [Aqui!](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

    #         Esta Ã© uma mensagem automÃ¡tica e informativa. Por favor, 

    