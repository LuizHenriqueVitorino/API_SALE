name: Teste Automático

on:
  push:
    branches:
      - main

jobs:
  Roda_A_API:
    runs-on: self-hosted

    steps:
    - name: Check out code
      uses: actions/checkout@v3

    - name: Install Flask
      run: pip install Flask
    
    - name: Install Robot and libraries
      run: |
        pip install robotframework
        pip install robotframework-requests

    - name: Start API
      run: |
        python3 mockes/mocke_sale.py &
        echo $! > api_pid.txt # Salva o PID da API em um arquivo
        sleep 2

    - name: Run Tests
      run: |
        robot testes/login_test.robot

    - name: Stop API
      run: |
        API_PID=$(cat api_pid.txt) # Lê o PID da API do arquivo
        kill $API_PID # Interrompe a execução da API

  notifyTelegram:
    name: Notify deploy status 🚀
    needs: [Roda_A_API]
    if: always()
    continue-on-error: true
    runs-on: self-hosted
    steps:
    - name: send custom message
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        format: markdown
        message: |
          ✅ Nova versão de *${{ env.STAGE_NAME }}* disponível!
            ⎿ 📌 Autor responsável: ${{ github.actor }}

            ✏️ De: [${{ github.repository }}](${{ github.repository.html_url }})

            🏷️ Versão : ```${{ env.PR_NUMBER_OR_MASTER }}```
            ⎿ 🛠️ Build : #```${{ github.run_number }}```

            🧬 Alterações: [Aqui!](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            📦 Deploy: [Aqui!](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            Esta é uma mensagem automática e informativa. Por favor, não responda.
      

    